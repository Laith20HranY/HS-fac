<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>HS request</title>
    <meta content="" name="description">
    <meta content="" name="keywords">
    <!-- Favicons -->
    <link href="assets/img/Hs logosmal.PNG" rel="icon">
    <link href="assets/img/HS logog.gif" rel="apple-touch-icon">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700" rel="stylesheet">
    <!-- Vendor CSS Files -->
    <link href="assets/vendor/aos/aos.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
    <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
    <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet">
    <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
    <!-- Main CSS File -->
    <link href="assets/css/style.css" rel="stylesheet">
    <style>
        #updateModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: calc(100% + 20px);
            height: calc(100% + 20px);
            background: white;
            border: 1px solid #ccc;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            padding: 20px;
            border-radius: 8px;
            max-width: 620px;
            max-height: 620px;
        }

        #updateModal .close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: transparent;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }

        #formFields {
            display: none;
        }
    </style>
</head>

<body>
    <header id="header" class="fixed-top header-inner-pages">
        <div class="container d-flex align-items-center justify-content-lg-between">
            <h1 class="logo me-auto me-lg-0"><a href="index.html">HS<span>.</span></a></h1>
            <nav id="navbar" class="navbar order-last order-lg-0">
                <ul>
                    <li><a class="nav-link scrollto active" href="managergate.html">Home</a></li>
                    <li><a class="nav-link scrollto" href="#services">Services</a></li>
                    <li class="dropdown"><a href="#"><span>Manage</span> <i class="bi bi-chevron-down"></i></a>
                        <ul>
                            <li><a href="m1.html">Orders</a></li>
                            <li class="dropdown"><a href="#"><span>View DPP</span> <i class="bi bi-chevron-right"></i></a>
                                <ul>
                                    <li><a href="m2.html">View Daily production report</a></li>
                                    <li><a href="m4.html"> View Daily malfunction report </a></li>
                                </ul>
                            </li>
                            <li><a href="m5.html">Post</a></li>
                            <li><a href="m7.html">Requests</a></li>
                        </ul>
                    </li>
                </ul>
                <i class="bi bi-list mobile-nav-toggle"></i>
            </nav><!-- .navbar -->
            <a href="index.html" class="get-started-btn scrollto">Logout</a>
        </div>
    </header>
    <main id="main">
        <section id="contact" class="contact">
            <div class="container" data-aos="fade-up">
                <div class="section-title">
                    <h2>Manage</h2>
                    <p>Add Orders</p>
                </div>
                <div class="row mt-5">
                    <div class="col-lg-8 mt-5 mt-lg-0">
                        <form id="orderForm" class="php-email-form" role="form">
                            <div class="row">
                                <table class="table table-striped table-bordered">
                                    <thead class="thead-dark">
                                        <div class="col-md-6 form-group">
                                            <input type="text" class="form-control" name="product_id" placeholder="Product ID" required />
                                        </div>
                                        <div id="messageBox2" class="message-box2"></div>
                                        <div class="col-md-6 form-group mt-3 mt-md-0">
                                            <input type="text" class="form-control" name="machine_id" placeholder="Machine ID" required />
                                        </div>
                                        <div class="col-md-6 form-group">
                                            <input type="number" class="form-control" name="quantity" placeholder="Quantity" required />
                                        </div>
                                        <div class="col-md-6 form-group">
                                            <input type="date" class="form-control" name="order_date" required />
                                        </div>
                                        <div class="col-md-6 form-group">
                                            <select class="form-control" name="status">
                                                <option value="Pending">Pending</option>
                                                <option value="In Progress">In Progress</option>
                                                <option value="Completed">Completed</option>
                                            </select>
                                        </div>
                                        <div class="text-center">
                                            <button id="ordermassage" type="submit">Submit Order</button>
                                        </div>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </form>
                        <button id="updateButton" class="btn btn-primary">Update Orders</button>
                        <div id="updateModal">
                            <button class="close" onclick="document.getElementById('updateModal').style.display='none'">&times;</button>
                            <form id="retrieveForm" class="php-email-form">
                                <label for="patch_num">Patch Number:</label>
                                <br>
                                <input type="text" id="retrieve_patch_num" name="patch_num" required>
                                <button type="button" id="retrieveButton">Retrieve</button>
                            </form>
                            <div id="formFields">
                                <form id="updateForm" class="php-email-form">
                                    <label for="product_id">Product ID:</label>
                                    <label for="machine_id">Machine ID:</label>
                                    <input type="text" id="update_machine_id" name="machine_id" required>
                                    <label for="quantity">Quantity:</label>
                                    <input type="number" id="update_quantity" name="quantity" required>
                                    <label for="order_date">Order Date:</label>
                                    <input type="date" id="update_order_date" name="order_date" required>
                                    <label for="status">Status:</label>
                                    <select id="update_status" name="status">
                                        <option value="Pending">Pending</option>
                                        <option value="In Progress">In Progress</option>
                                        <option value="Completed">Completed</option>
                                    </select>
                                    <button type="submit">Update Order</button>
                                </form>
                            </div>
                        </div>
                        <div id="orders-container"></div> 

                        <script>
                        document.getElementById('orderForm').addEventListener('submit', async (e) => {
        e.preventDefault(); // Prevent the default form submission behavior

        const messageBox = document.getElementById('messageBox2');
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        try {
            const response = await fetch('/submit-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });

            if (response.ok) {
                const { newOrder } = await response.json();
                messageBox.textContent = 'Your order has been submitted successfully!';
                messageBox.style.color = 'green';

                // Add the new order to the table in orders.html
                const event = new CustomEvent('orderSubmitted', { detail: newOrder });
                window.parent.dispatchEvent(event);

                e.target.reset();
            } else {
                const errorText = await response.text();
                messageBox.textContent = `Error: ${errorText}`;
                messageBox.style.color = 'red';
            }
        } catch (error) {
            messageBox.textContent = 'Error: Unable to submit data to the server!';
            messageBox.style.color = 'red';
        } finally {
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 3000);
        }
    });


              fetch('/orders')
                .then((res) => res.json())
                .then((orders) => {
                  const tbody = document.querySelector('table tbody');
                  const thead = document.querySelector('table thead');
                  thead.innerHTML = `
                    <tr>
                      <th>Product ID</th>
                      <th>Machine ID</th>
                      <th>Quantity</th>
                      <th>Order Date</th>
                      <th>Status</th>
                      <th>Patch Number</th>
                      <th>Actions</th>
                    </tr>
                  `;

                  orders.forEach((order) => {
                    tbody.innerHTML += `
                      <tr>
                        <td>${order.product_id}</td>
                        <td>${order.machine_id}</td>
                        <td>${order.quantity}</td>
                        <td>${new Date(order.order_date).toLocaleDateString()}</td>
                        <td>${order.status}</td>
                        <td>${order.patch_num}</td>
                        <td>
                          <button class="btn btn-danger" onclick="deleteOrder(${order.patch_num})">Delete</button>
                        </td>
                      </tr>
                    `;
                  });
                })
                .catch((error) => console.error('Error fetching orders:', error));

              async function deleteOrder(patch_num) {
                try {
                  const response = await fetch(`/delete-order-by-patch/${patch_num}`, {
                    method: 'DELETE',
                  });
                  if (response.ok) {
                    document.querySelector(`button[onclick="deleteOrder(${patch_num})"]`).closest('tr').remove();
                  } else {
                    console.error('Failed to delete order');
                  }
                } catch (error) {
                  console.error('Error:', error);
                }
              }

              document.getElementById('updateButton').addEventListener('click', function () {
                document.getElementById('updateModal').style.display = 'block';
              });

              document.getElementById('retrieveButton').addEventListener('click', async function () {
                const productId = document.getElementById('retrieve_product_id').value;
                if (productId) {
                  try {
                    const response = await fetch(`/orders?product_id=${productId}`);
                    if (response.ok) {
                      const orders = await response.json();
                      if (orders.length > 0) {
                        const order = orders[0];
                        document.getElementById('update_machine_id').value = order.machine_id;
                        document.getElementById('update_quantity').value = order.quantity;
                        document.getElementById('update_order_date').value = new Date(order.order_date).toISOString().split('T')[0];
                        document.getElementById('update_status').value = order.status;
                        document.getElementById('formFields').style.display = 'block';
                      } else {
                        console.error('Order not found');
                      }
                    } else {
                      console.error('Error fetching order');
                    }
                  } catch (error) {
                    console.error('Error fetching order:', error);
                  }
                }
              });

              document.getElementById('updateForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const messageBox = document.getElementById('messageBox2');
                if (!messageBox) {
                  console.error('Message box element is missing in the DOM.');
                  return;
                }

                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                const patchNum = data.patch_num; // Ensure patch_num is correctly extracted

                try {
                  const response = await fetch(`/update-order/${patchNum}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                  });

                  if (response.ok) {
                    const updatedOrder = await response.json();
                    messageBox.textContent = 'Your order has been updated successfully!';
                    messageBox.style.color = 'green';
                    e.target.reset();
                    setTimeout(() => {
                      window.top.location.href = window.top.location.href; // Exit iframe and refresh parent window
                    }, 2000);
                  } else {
                    const errorText = await response.text();
                    messageBox.textContent = `Error: ${errorText}`;
                    messageBox.style.color = 'red';
                  }
                } catch (error) {
                  messageBox.textContent = 'Error: Unable to update data!';
                  messageBox.style.color = 'red';
                } finally {
                  messageBox.style.display = 'block';
                  setTimeout(() => {
                    messageBox.style.display = 'none';
                  }, 3000);
                }
              });

              // Function to fetch and return the orders table
              async function fetchOrdersTable() {
                try {
                  // Fetch the content of m1.html
                  const response = await fetch('m1.html');
                  const text = await response.text();

                  // Create a temporary DOM element to parse the HTML content
                  const tempDiv = document.createElement('div');
                  tempDiv.innerHTML = text;

                  // Extract the orders table
                  const ordersTable = tempDiv.querySelector('table#ordersTable');

                  return ordersTable;
                } catch (error) {
                  console.error('Error fetching orders table:', error);
                }
              }

              // Ensure the orders table is displayed in the orders-container
              window.onload = async function() {
                const ordersTable = await fetchOrdersTable();
                if (ordersTable) {
                  document.getElementById('orders-container').appendChild(ordersTable);
                }
              };
                        </script>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer id="footer">
        <div class="footer-top">
            <div class="container">
                <div class="row">
                    <div class="col-lg-3 col-md-6">
                        <div class="footer-info">
                            <h3>HS<span>.</span></h3>
                            <p>
                                al zarqa'a <br>
                                AM 535022, JOR<br><br>
                                <strong>Phone:</strong> +1 5589 55488 55<br>
                                <strong>Email:</strong> hashimete student factory@gmail.com<br>
                            </p>
                            <div class="social-links mt-3">
                                <a href="#" class="twitter"><i class="bx bxl-twitter"></i></a>
                                <a href="#" class="facebook"><i class="bx bxl-facebook"></i></a>
                                <a href="#" class="instagram"><i class="bx bxl-instagram"></i></a>
                                <a href="#" class="google-plus"><i class="bx bxl-skype"></i></a>
                                <a href="#" class="linkedin"><i class="bx bxl-linkedin"></i></a>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-6 footer-links">
                        <h4>Useful Links</h4>
                        <ul>
                            <li><i class="bx bx-chevron-right"></i> <a href="#">Home</a></li>
                            <li><i class="bx bx-chevron-right"></i> <a href="#">About us</a></li>
                            <li><i class="bx bx-chevron-right"></i> <a href="#">Services</a></li>
                            <li><i class="bx bx-chevron-right"></i> <a href="#">Terms of service</a></li>
                            <li><i class="bx bx-chevron-right"></i> <a href="#">Privacy policy</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="copyright">
                &copy; Copyright <strong><span>HS</span></strong>. All Rights Reserved
            </div>
            <div class="credits">
                Developed by <a style="color: #ffc451;">HS team</a>
            </div>
        </div>
    </footer>

    <div id="preloader"></div>
    <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

    <!-- Vendor JS Files -->
    <script src="assets/vendor/purecounter/purecounter_vanilla.js"></script>
    <script src="assets/vendor/aos/aos.js"></script>
    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
    <script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
    <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
    <script src="assets/vendor/php-email-form/validate.js"></script>
    <!-- Template Main JS File -->
    <script src="assets/js/main.js"></script>
</body>

</html>